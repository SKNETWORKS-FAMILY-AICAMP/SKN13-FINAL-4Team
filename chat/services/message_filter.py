# backend/chat/services/message_filter.py
import re
import asyncio
from openai import AsyncOpenAI
from django.conf import settings

# OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
openai_client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)

# í•˜ë“œë¸”ë¡ ì •ê·œì‹ (ì œê³µëœ íŒ¨í„´ ì‚¬ìš©)
HARD_BLOCK_PATTERNS = [
    # ì„±ì  ë°œì–¸
    r"(ì„¹ìŠ¤|ììœ„|í¬ë¥´ë…¸|ì•¼ë™|69|ë”¥ì“°|ê°•ê°„|ê°•ì œ\s*ê´€ê³„|ì•„ë™\s*ì„±|ìˆ˜ê°„|ì„±ê¸°)",
    r"(fuck|porn|blowjob|handjob|cum|bitch|dick|pussy)",

    # ìš•ì„¤ / í˜ì˜¤
    r"(ë³‘ì‹ |ê°œìƒˆë¼|ë‹ˆì• ë¯¸|ì§€ë„|retard|cuck|ì¢†ê°™|êº¼ì ¸|ë‹¥ì³)",

    # ìì‚´ / í­ë ¥ / í…ŒëŸ¬
    r"(ìì‚´|í…ŒëŸ¬|í­íƒ„|ì´ê¸°\s*êµ¬ë§¤|ì¹¼\s*ì‚¬ìš©|í­ë ¥\s*ì¡°ì¥)",

    # ë¶ˆë²• í–‰ìœ„
    r"(ë§ˆì•½\s*ì œì¡°|í•´í‚¹\s*ë°©ë²•|ë¶ˆë²•\s*ë‹¤ìš´ë¡œë“œ|ì‹ ë¶„ì¦\s*ìœ„ì¡°|ìŠ¤íŒ¸\s*í™ë³´)",

    # ì‚´í•´ ìœ„í˜‘
    r"(ë„ˆ.*ì£½ì—¬|ì£½ì—¬ë²„ë ¤|ì£½ì¼ê±°ì•¼|ì£½ëŠ”ë‹¤\s*XX)",

    # ğŸ”½ ì¶”ê°€: ì´ê¸° ì œì‘/ë¶€í’ˆ ê´€ë ¨
    r"(ì´ê¸°\s*ì œì‘|ì´ê¸°\s*ë¶€í’ˆ|ì´ê¸°\s*ì¡°ë¦½|3D\s*í”„ë¦°íŠ¸.*ì´|ì´.*í”„ë¦°íŠ¸|ë¬´ê¸°\s*ì¡°ë¦½)",
    r"(íƒ„ì•½\s*ì œì¡°|ì´ì•Œ\s*ì œì‘|í­ë°œë¬¼\s*ì¡°ë¦½|í™”ì•½\s*ì¡°ì œ)",
]
HARD_BLOCK_RE = re.compile("|".join(HARD_BLOCK_PATTERNS), re.IGNORECASE)

GUARD_TIMEOUT_SEC = 4.0

async def rule_based_filter(message: str) -> bool:
    """ì •ê·œì‹ ê¸°ë°˜ì˜ 1ì°¨ í•„í„°. ë¶€ì ì ˆí•œ ë‹¨ì–´ê°€ í¬í•¨ë˜ë©´ Trueë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    if HARD_BLOCK_RE.search(message):
        return True
    return False

async def ai_context_filter(message: str) -> bool:
    """GPT-3.5-turboë¥¼ ì´ìš©í•œ 2ì°¨ ë§¥ë½ í•„í„°. ë¶€ì ì ˆí•œ ë§¥ë½ì´ë©´ Trueë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""

    prompt = f"""
    ë‹¤ìŒ ë©”ì‹œì§€ê°€ ì„±ì ì´ê±°ë‚˜, ë¶ˆë²•ì ì´ê±°ë‚˜, í˜ì˜¤ ë°œì–¸ì„ í¬í•¨í•˜ëŠ” ë“± ë°©ì†¡ ê°€ì´ë“œë¼ì¸ì— ìœ„ë°°ë˜ëŠ”ì§€ íŒë‹¨í•´ì¤˜.
    íŒë‹¨ ê¸°ì¤€:
    - ì§ì ‘ì ì¸ ìš•ì„¤, ì„±ì ì¸ ë‹¨ì–´
    - ëŒë ¤ ë§í•˜ëŠ” ì„±í¬ë¡± ë˜ëŠ” ê´´ë¡­í˜
    - ë¶ˆë²•ì ì¸ í™œë™ì„ ì¡°ì¥í•˜ê±°ë‚˜ ë…¼ì˜í•˜ëŠ” ë‚´ìš©(ì˜ˆ: ë§ˆì•½, í•´í‚¹, ë¶ˆë²• ë¬´ê¸° ì œì¡°Â·íŒë§¤, ì´ê¸° ë¶€í’ˆ ì œì‘Â·ì¡°ë¦½ ë“±)
    - íŠ¹ì • ì§‘ë‹¨ì— ëŒ€í•œ ì°¨ë³„ì´ë‚˜ í˜ì˜¤ë¥¼ ì¡°ì¥í•˜ëŠ” ë°œì–¸

    ì¶”ê°€ ê·œì¹™:
    - ë‹¨ìˆœ ë°˜ë³µë¬¸ì (ì˜ˆ: ã…‹ã…‹ã…‹ã…‹, ã…ã…ã…, ã… ã… ã… , ã…ã…‡ã…ã…‡) ì™€ ê°™ì´
      ì˜ë¯¸ ì—†ëŠ” íŒ¨í„´ì¼ ê²½ìš°ëŠ” "ì ì ˆ"ë¡œ íŒë‹¨í•´ì•¼ í•œë‹¤.
    - í•˜ì§€ë§Œ ìš•ì„¤ì´ë‚˜ ê¸ˆì¹™ì–´ê°€ ì„ì—¬ ìˆìœ¼ë©´ "ë¶€ì ì ˆ"ë¡œ íŒë‹¨í•œë‹¤.

    ì£¼ì˜:
    - ê°íƒ„ì‚¬ë‚˜ ê³¼ì¥ëœ í‘œí˜„(ì˜ˆ: "ì›ƒê²¨ ì£½ê² ë‹¤", "ë°°ë¶ˆëŸ¬ ì£½ê² ë‹¤", "ì¢‹ì•„ ì£½ê² ë‹¤")ì€ 'ì ì ˆ'ë¡œ íŒë‹¨í•œë‹¤.
    - ì¸í„°ë„· ë°ˆ/ìœ í–‰ì–´(ì˜ˆ: "ë¯¸ì³¤ë‹¤", "ë ˆì „ë“œë‹¤", "ê¸°ì ˆê°", "ë’¤ì§„ë‹¤")ëŠ” 'ì ì ˆ'ë¡œ íŒë‹¨í•œë‹¤.
    - ë§¥ë½ìƒ ì¼ìƒì ì´ë©´ 'ì ì ˆ'ë¡œ ì²˜ë¦¬í•œë‹¤.


    ê°€ì´ë“œë¼ì¸ì— ìœ„ë°°ëœë‹¤ë©´ "ë¶€ì ì ˆ", ê·¸ë ‡ì§€ ì•Šë‹¤ë©´ "ì ì ˆ" ì´ë¼ê³ ë§Œ ëŒ€ë‹µí•´ì¤˜.

    ë©”ì‹œì§€: "{message}"
    """
    try:
        response = await asyncio.wait_for(
            openai_client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=10,
                temperature=0.0,
            ),
            timeout=GUARD_TIMEOUT_SEC
        )
        result = response.choices[0].message.content.strip()
        return "ë¶€ì ì ˆ" in result
    except asyncio.TimeoutError:
        # AI í•„í„°ê°€ ì‹œê°„ ì´ˆê³¼ë˜ë©´ ì•ˆì „ì„ ìœ„í•´ ë¶€ì ì ˆí•œ ê²ƒìœ¼ë¡œ ê°„ì£¼
        return True
    except Exception:
        # ê·¸ ì™¸ ì˜ˆì™¸ ë°œìƒ ì‹œì—ë„ ì•ˆì „ì„ ìœ„í•´ ë¶€ì ì ˆí•œ ê²ƒìœ¼ë¡œ ê°„ì£¼
        return True

async def is_message_blocked(message: str) -> bool:
    """
    ë£° ê¸°ë°˜ í•„í„°ì™€ AI í•„í„°ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì ìš©í•˜ì—¬ ë©”ì‹œì§€ ì°¨ë‹¨ ì—¬ë¶€ë¥¼ ìµœì¢… ê²°ì •í•©ë‹ˆë‹¤.
    í•˜ë‚˜ë¼ë„ ë¶€ì ì ˆí•˜ë‹¤ê³  íŒë‹¨í•˜ë©´ Trueë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    # 1ì°¨: ë£° ê¸°ë°˜ í•„í„°
    if await rule_based_filter(message):
        return True
    
    # 2ì°¨: AI ë§¥ë½ ê¸°ë°˜ í•„í„°
    if await ai_context_filter(message):
        return True
        
    return False
